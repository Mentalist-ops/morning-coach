<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>朝のじゅんびコーチ（1ファイル簡易版）</title>
<meta name="theme-color" content="#0ea5e9">
<style>
  :root{--bg:#f7fafc;--fg:#0f172a;--muted:#475569;--brand:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444;--card:#fff;--shadow:0 6px 20px rgba(2,6,23,.07);--tap:56px;--radius:16px}
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,system-ui,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;color:var(--fg);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:rgba(247,250,252,.9);backdrop-filter:blur(6px);border-bottom:1px solid #e5e7eb}
  .bar{display:flex;gap:8px;align-items:center;max-width:1000px;margin:0 auto;padding:12px 16px}
  .brand{font-weight:800}.spacer{flex:1}
  .btn{cursor:pointer;min-height:48px;padding:10px 14px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:800;box-shadow:var(--shadow)}
  .btn.ghost{background:#e2f2fb;color:#0369a1}.btn.ok{background:var(--ok)}.btn.warn{background:var(--warn)}.btn.danger{background:var(--danger)}
  main{max-width:1000px;margin:8px auto 80px;padding:12px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .headline{display:flex;align-items:center;gap:8px}
  .remain{font-size:32px;font-weight:900}.depart{font-size:14px;color:var(--muted)} .depart strong{color:var(--fg)}
  .now{display:flex;gap:10px;align-items:center;margin-top:8px}.now h3{margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .list{background:#f1f5f9;border-radius:12px;padding:8px;margin-top:12px}
  .task{display:flex;align-items:center;gap:10px;background:#fff;border-radius:12px;padding:10px;margin:6px 0;box-shadow:var(--shadow)}
  .drag{cursor:grab;opacity:.8}
  dialog{border:none;border-radius:14px;box-shadow:var(--shadow);max-width:560px;width:96%}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  input,select{min-height:44px;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1}
  .hint{font-size:13px;color:var(--muted)}
  .badge{position:fixed;right:8px;bottom:8px;font-size:12px;opacity:.6}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">🌅 朝のじゅんびコーチ（簡易1ファイル）</div>
    <div class="spacer"></div>
    <button id="btnParent" class="btn ghost">親ダッシュボード</button>
  </div>
</header>

<main class="grid">
  <!-- 6歳 -->
  <section id="p_k6" class="card" aria-labelledby="h6">
    <div class="headline"><h2 id="h6">6歳（小学生）</h2><div id="stars_k6" style="margin-left:auto">⭐0</div></div>
    <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap">
      <div class="remain" id="rem_k6">--:--</div>
      <div class="depart" id="dep_k6">出発 <strong>07:55</strong>（長押しで編集）</div>
    </div>
    <div class="hint">「はじめる」を押すと音声ガイド開始</div>
    <div class="now"><div style="font-size:24px">🌞</div><div><h3 id="now_k6">起床</h3><div id="meta_k6" class="hint">所要 1分 / タップ</div></div></div>
    <div class="controls">
      <button class="btn ok" data-cmd="done"  data-id="kid_6">できた！</button>
      <button class="btn ghost" data-cmd="hint" data-id="kid_6">わからない</button>
      <button class="btn warn" data-cmd="skip" data-id="kid_6">スキップ（親）</button>
      <button class="btn"      data-cmd="begin" data-id="kid_6">はじめる</button>
      <button class="btn ghost" data-cmd="add" data-id="kid_6">＋タスク</button>
    </div>
    <div id="next_k6" class="hint" style="margin-top:6px">つぎ：—</div>
    <div id="list_k6" class="list" aria-label="並べ替えリスト"></div>
  </section>

  <!-- 3歳 -->
  <section id="p_k3" class="card" aria-labelledby="h3">
    <div class="headline"><h2 id="h3">3歳（保育園）</h2><div id="stars_k3" style="margin-left:auto">⭐0</div></div>
    <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap">
      <div class="remain" id="rem_k3">--:--</div>
      <div class="depart" id="dep_k3">出発 <strong>09:00</strong>（長押しで編集）</div>
    </div>
    <div class="hint">「はじめる」を押すと音声ガイド開始</div>
    <div class="now"><div style="font-size:24px">🌞</div><div><h3 id="now_k3">起床</h3><div id="meta_k3" class="hint">所要 1分 / タップ</div></div></div>
    <div class="controls">
      <button class="btn ok" data-cmd="done"  data-id="kid_3">できた！</button>
      <button class="btn ghost" data-cmd="hint" data-id="kid_3">わからない</button>
      <button class="btn warn" data-cmd="skip" data-id="kid_3">スキップ（親）</button>
      <button class="btn"      data-cmd="begin" data-id="kid_3">はじめる</button>
      <button class="btn ghost" data-cmd="add" data-id="kid_3">＋タスク</button>
    </div>
    <div id="next_k3" class="hint" style="margin-top:6px">つぎ：—</div>
    <div id="list_k3" class="list" aria-label="並べ替えリスト"></div>
  </section>
</main>

<!-- 親ダイアログ -->
<dialog id="dlgParent">
  <form method="dialog">
    <h3>親ダッシュボード</h3>
    <div class="field">
      <label>対象プロフィール</label>
      <select id="selProfile"><option value="kid_6">6歳</option><option value="kid_3">3歳</option></select>
    </div>
    <div class="field">
      <label>出発時刻（今日だけ）</label>
      <input id="overrideTime" placeholder="例 07:55">
    </div>
    <div class="field">
      <label>学年（0=未就学, 1〜6）</label>
      <input id="gradeInput" type="number" min="0" max="6" step="1" value="1">
    </div>
    <div class="field">
      <label>親PIN（空なら無効）</label>
      <input id="pinInput" inputmode="numeric" maxlength="4" placeholder="1234">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnExport" class="btn ghost" type="button">エクスポート</button>
      <input id="fileImport" type="file" accept="application/json">
      <button class="btn">とじる</button>
    </div>
  </form>
</dialog>

<!-- タスク追加/編集 -->
<dialog id="dlgTask">
  <form method="dialog">
    <h3>タスク追加/編集</h3>
    <div class="field"><label>名前（必須）</label><input id="taskName"></div>
    <div class="field"><label>所要分（0.5〜30）</label><input id="taskMin" type="number" step="0.5" min="0.5" max="30" value="1"></div>
    <div class="field"><label>方式</label><select id="taskMode"><option value="tap">タップ</option><option value="timer">タイマー</option></select></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnDelTask" class="btn danger" type="button">削除</button>
      <button id="btnSaveTask" class="btn ok" type="button">保存</button>
    </div>
  </form>
</dialog>

<div class="badge">build: simple-1file-r3</div>

<script type="module">
// ====== 1) データ（端末内に保存） ======
const KEY='mc.simple.v1';
/** @typedef {{id:string,label:string,minutes:number,mode:'tap'|'timer'}} Task */
/** @typedef {{name:string,age:number,schoolGrade:number,targetDeparture:string,todayOverride:string|null,tasks:Task[],stars:number}} Profile */
/** @type {{profiles:Record<string,Profile>,settings:{pin:string,ttsRate:number}}} */
const defaultState={
  profiles:{
    kid_6:{name:'6歳',age:6,schoolGrade:1,targetDeparture:'07:55',todayOverride:null,stars:0,tasks:[
      {id:'wake',label:'起床',minutes:1,mode:'tap'},{id:'toilet',label:'トイレ',minutes:3,mode:'timer'},
      {id:'wash',label:'顔を洗う',minutes:2,mode:'tap'},{id:'tooth',label:'歯みがき',minutes:2,mode:'timer'},
      {id:'dress',label:'着替え',minutes:3,mode:'tap'},{id:'bag',label:'持ち物チェック',minutes:2,mode:'tap'},
      {id:'rice',label:'朝ごはん',minutes:10,mode:'timer'},{id:'clean',label:'片付け',minutes:2,mode:'tap'},
      {id:'run',label:'出発準備',minutes:1,mode:'tap'},
    ]},
    kid_3:{name:'3歳',age:3,schoolGrade:0,targetDeparture:'09:00',todayOverride:null,stars:0,tasks:[
      {id:'wake',label:'起床',minutes:1,mode:'tap'},{id:'toilet_assist',label:'トイレ（補助）',minutes:4,mode:'timer'},
      {id:'wipe_face',label:'顔を拭く',minutes:2,mode:'tap'},{id:'tooth',label:'歯みがき（補助）',minutes:2,mode:'timer'},
      {id:'dress',label:'着替え',minutes:3,mode:'tap'},{id:'socks',label:'靴下',minutes:1,mode:'tap'},
      {id:'rice',label:'朝ごはん',minutes:12,mode:'timer'},{id:'clean',label:'片付け',minutes:2,mode:'tap'},
      {id:'run',label:'出発準備',minutes:1,mode:'tap'},
    ]},
  },
  settings:{pin:'',ttsRate:1.0}
};
let state=load(); function load(){try{const r=localStorage.getItem(KEY); return r? JSON.parse(r):structuredClone(defaultState)}catch{return structuredClone(defaultState)}}
function save(){localStorage.setItem(KEY,JSON.stringify(state))}

// ====== 2) 学年未満はかなにする ======
const KANJI_GRADE={'朝':2,'歳':99,'小':1,'学':1,'生':1,'遅':99,'分':2,'起':3,'床':99,'所':3,'要':4,'時':2,'間':2,'同':2,'顔':2,'洗':6,'歯':3,'着':3,'替':99,'持':3,'物':3,'片':6,'付':4,'出':1,'発':3,'準':5,'備':5};
const PHRASE={
  '出発準備':'でかけるじゅんび','起床':'おきる','同時':'いっしょ','所要':'じかん','遅れ':'おくれ',
  '着替え':'きがえ','持ち物':'もちもの','片付け':'かたづけ','朝':'あさ','時間':'じかん',
  '洗う':'あらう','顔':'かお','歯':'は','小学生':'しょうがくせい','気分':'きぶん'
};
const CHAR={'朝':'あさ','歳':'さい','遅':'おく','分':'ふん','起':'お','床':'ゆか','所':'ところ','要':'よう','時':'じ','間':'ま','同':'おなじ','顔':'かお','洗':'あら','歯':'は','着':'き','替':'か','持':'も','物':'もの','片':'かた','付':'つ','出':'で','発':'はつ','準':'じゅん','備':'び'};
const isKanji = ch=>/[\u4E00-\u9FFF]/.test(ch);
const kgrade = ch=> KANJI_GRADE[ch] ?? 99;
function toKanaByGrade(text, grade){
  let out=text;
  for(const [p,y] of Object.entries(PHRASE)){
    if(out.includes(p)){
      const tooHard=[...p].some(ch=> isKanji(ch) && kgrade(ch)>grade);
      if(tooHard || grade===0) out=out.split(p).join(y);
    }
  }
  out=[...out].map(ch=> (isKanji(ch) && (kgrade(ch)>grade||grade===0)) ? (CHAR[ch]??ch) : ch).join('');
  return out;
}

// ====== 3) ユーティリティ ======
const qs=(s,root=document)=>root.querySelector(s);
function hhmmToMin(s){const [h,m]=s.split(':').map(Number); return h*60+m}
function nowMinTokyo(){const s=new Intl.DateTimeFormat('en-GB',{timeZone:'Asia/Tokyo',hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date()); const [h,m]=s.split(':').map(Number); return h*60+m}

// ====== 4) 音声（TTS） ======
let vJA=null; function pickVoice(){const vs=speechSynthesis.getVoices(); vJA=vs.find(v=>/ja-JP/i.test(v.lang))||vs.find(v=>/ja/i.test(v.lang))||null}
speechSynthesis.addEventListener('voiceschanged', pickVoice); pickVoice();
function speak(t){const u=new SpeechSynthesisUtterance(t); if(vJA)u.voice=vJA; u.lang='ja-JP'; u.rate=state.settings.ttsRate; try{speechSynthesis.cancel()}catch{} speechSynthesis.speak(u)}
// パーツごとに順番再生（間をつくる・語尾↑調整）
function speakSeq(parts){
  try{ speechSynthesis.cancel(); }catch{}
  let i=0;
  const play=()=>{
    if(i>=parts.length) return;
    const seg=parts[i++];
    const u=new SpeechSynthesisUtterance(seg.text);
    if(vJA) u.voice=vJA;
    u.lang='ja-JP';
    u.rate=seg.rate ?? state.settings.ttsRate;
    u.pitch=seg.pitch ?? 1.0;
    speechSynthesis.speak(u);
    u.onend=play;
  };
  play();
}

// ====== 5) 描画 ======
function prof(id){return state.profiles[id]}
function depTime(p){return p.todayOverride || p.targetDeparture}
function remainMin(p){return hhmmToMin(depTime(p)) - nowMinTokyo()}

function renderOne(id){
  const p=prof(id); const g=p.schoolGrade;
  // 見出し（かな化）
  qs(id==='kid_6'?'#h6':'#h3').textContent = p.age<=3 ? '3さい（ほいくえん）' : '6さい（しょうがくせい）';
  // 出発表示
  const depLbl = toKanaByGrade('出発',g).replace('出発','でるじかん');
  qs(id==='kid_6'?'#dep_k6':'#dep_k3').innerHTML = `${depLbl} <strong>${depTime(p)}</strong>（長押しで編集）`;
  // 残り
  const r=remainMin(p); qs(id==='kid_6'?'#rem_k6':'#rem_k3').textContent = r>=0? `${String(Math.floor(r/60)).padStart(2,'0')}:${String(r%60).padStart(2,'0')}` : toKanaByGrade(`遅れ ${Math.abs(r)}分`, g);
  // タスク
  const now = p.tasks[0];
  qs(id==='kid_6'?'#now_k6':'#now_k3').textContent = now? toKanaByGrade(now.label,g): toKanaByGrade('すべて完了！',g);
  qs(id==='kid_6'?'#meta_k6':'#meta_k3').textContent = now? toKanaByGrade(`所要 ${now.minutes}分 / ${now.mode==='timer'?'タイマー':'タップ'}`, g):'';
  qs(id==='kid_6'?'#next_k6':'#next_k3').textContent = p.tasks[1]? toKanaByGrade(`つぎ：「${p.tasks[1].label}」 / ${p.tasks[1].minutes}分`, g) : 'つぎ：—';
  qs(id==='kid_6'?'#stars_k6':'#stars_k3').textContent = `⭐${p.stars||0}`;

  // 並べ替えリスト
  const list=qs(id==='kid_6'?'#list_k6':'#list_k3'); list.innerHTML='';
  p.tasks.forEach((t,idx)=>{
    const el=document.createElement('div'); el.className='task'; el.draggable=true; el.dataset.index=idx;
    el.innerHTML=`<div class="drag" title="↕">↕</div>
      <div style="flex:1"><strong>${toKanaByGrade(t.label,g)}</strong><div class="hint">${t.minutes}分 / ${t.mode==='timer'?'タイマー':'タップ'}</div></div>
      <button class="btn ghost" data-edit="${idx}" data-id="${id}">編集</button>`;
    list.appendChild(el);
  });

  // DnD
  let dragIdx=null;
  list.ondragstart=e=>{const t=e.target;if(!(t instanceof HTMLElement))return; dragIdx=Number(t.closest('.task')?.dataset.index); t.style.opacity=.6}
  list.ondragend=e=>{const t=e.target;if(!(t instanceof HTMLElement))return; t.style.opacity=1}
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault(); const target=e.target.closest('.task'); if(!target) return;
    const dropIdx=Number(target.dataset.index); if(dropIdx===dragIdx||dragIdx==null) return;
    const arr=p.tasks; const [m]=arr.splice(dragIdx,1); arr.splice(dropIdx,0,m); save(); renderOne(id);
  };

  // 個別編集
  list.onclick=e=>{
    const b=e.target.closest('button[data-edit]'); if(!b) return;
    openTaskEditor(id, Number(b.dataset.edit));
  }
}

function tick(){['kid_6','kid_3'].forEach(renderOne)} setInterval(tick,1000); tick();

// ====== 6) クリック操作 ======
document.body.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const cmd=btn.dataset.cmd, id=btn.dataset.id;
  if(cmd==='begin'){
    const g=prof(id).schoolGrade;
    const say=[
      { text: toKanaByGrade('おはよう！', g), rate:1.05, pitch:1.2 },     // 語尾↑
      { text: toKanaByGrade('きょうの きぶんは、', g) },                // 「気分」は語彙変換で“きぶん”
      { text: toKanaByGrade('わくわく、', g) },                         // 間あけ
      { text: toKanaByGrade('ねむい、', g) },
      { text: toKanaByGrade('ふつう、', g) },
      { text: toKanaByGrade('から えらんでね！', g), pitch:1.15 }       // 語尾↑
    ];
    speakSeq(say);
  }
  if(cmd==='done'){
    const p=prof(id); if(!p.tasks.length) return; const t=p.tasks.shift();
    p.stars=(p.stars||0)+1; save(); renderOne(id);
    const g=p.schoolGrade;
    speak(toKanaByGrade(`「${t.label}」できた！つぎは「${p.tasks[0]?.label||'おしまい'}」だよ。`, g));
  }
  if(cmd==='hint'){
    const p=prof(id); const g=p.schoolGrade; const t=p.tasks[0];
    speak(toKanaByGrade(t?`${t.label} のヒントだよ。ゆっくりでだいじょうぶ！`:'いっしょに すすもう！', g));
  }
  if(cmd==='skip'){
    const pin=state.settings.pin; if(pin){ const x=prompt('親PINを入力'); if(x!==pin) return alert('PINが違います'); }
    const p=prof(id); if(!p.tasks.length) return; p.tasks.shift(); save(); renderOne(id);
  }
  if(cmd==='add'){ openTaskEditor(id,-1); }
});

/* ====== 7) 出発時刻（長押し編集） ====== */
[['#dep_k6','kid_6'],['#dep_k3','kid_3']].forEach(([sel,id])=>{
  const el=qs(sel); let t=null;
  el.addEventListener('mousedown',()=>{t=setTimeout(()=>editTime(id),500)});
  el.addEventListener('mouseup',()=>clearTimeout(t));
  el.addEventListener('touchstart',()=>{t=setTimeout(()=>editTime(id),500)},{passive:true});
  el.addEventListener('touchend',()=>clearTimeout(t));
});
function editTime(id){
  const v=prompt('出発時刻（HH:MM）', depTime(prof(id)));
  if(!v) return; if(!/^\d{2}:\d{2}$/.test(v)) return alert('HH:MM 形式');
  prof(id).todayOverride=v; save(); renderOne(id);
}

/* ====== 8) 親ダッシュボード & タスク編集 ====== */
const dlgParent=qs('#dlgParent'), dlgTask=qs('#dlgTask');
qs('#btnParent').onclick=()=>dlgParent.showModal();
qs('#selProfile').onchange=()=>{qs('#gradeInput').value=String(prof(qs('#selProfile').value).schoolGrade||0); qs('#overrideTime').value=prof(qs('#selProfile').value).todayOverride||''}
qs('#gradeInput').onchange=e=>{const id=qs('#selProfile').value; const v=Number(e.target.value||'0'); if(v<0||v>6) return alert('0〜6'); prof(id).schoolGrade=v; save(); renderOne(id);}
qs('#overrideTime').onchange=e=>{const id=qs('#selProfile').value; const v=e.target.value.trim(); prof(id).todayOverride=v||null; save(); renderOne(id)}
qs('#pinInput').onchange=e=>{state.settings.pin=e.target.value.trim(); save()}

qs('#btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='morningCoach_backup.json'; a.click(); }
qs('#fileImport').onchange=async e=>{const f=e.target.files?.[0]; if(!f) return; try{state=JSON.parse(await f.text()); save(); location.reload()}catch{alert('JSON形式エラー')} }

let taskCtx={id:'kid_6',idx:-1};
function openTaskEditor(id,idx){
  taskCtx={id,idx};
  const isNew=idx===-1, p=prof(id);
  qs('#taskName').value=isNew?'':p.tasks[idx]?.label||'';
  qs('#taskMin').value=isNew?'1':String(p.tasks[idx]?.minutes||1);
  qs('#taskMode').value=isNew?'tap':p.tasks[idx]?.mode||'tap';
  dlgTask.showModal();
}
qs('#btnSaveTask').onclick=()=>{
  const name=qs('#taskName').value.trim(); const minutes=Number(qs('#taskMin').value); const mode=qs('#taskMode').value;
  if(!name) return alert('名前は必須'); if(!(minutes>=0.5&&minutes<=30)) return alert('0.5〜30で入力');
  const arr=prof(taskCtx.id).tasks;
  if(taskCtx.idx===-1){ arr.push({id:'t_'+Date.now(),label:name,minutes,mode}); }
  else{ Object.assign(arr[taskCtx.idx],{label:name,minutes,mode}); }
  save(); renderOne(taskCtx.id); dlgTask.close();
};
qs('#btnDelTask').onclick=()=>{
  if(taskCtx.idx===-1){ dlgTask.close(); return; }
  const arr=prof(taskCtx.id).tasks; arr.splice(taskCtx.idx,1); save(); renderOne(taskCtx.id); dlgTask.close();
};

// ====== 9) （ローカル file:// ではSWは無効。公開後に有効化予定） ======
</script>
</body>
</html>
