<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>æœã®ã˜ã‚…ã‚“ã³ã‚³ãƒ¼ãƒï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ç°¡æ˜“ç‰ˆï¼‰</title>
<meta name="theme-color" content="#0ea5e9">
<style>
  :root{--bg:#f7fafc;--fg:#0f172a;--muted:#475569;--brand:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444;--card:#fff;--shadow:0 6px 20px rgba(2,6,23,.07);--tap:56px;--radius:16px}
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,system-ui,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;color:var(--fg);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:rgba(247,250,252,.9);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);border-bottom:1px solid #e5e7eb}
  .bar{display:flex;gap:8px;align-items:center;max-width:1000px;margin:0 auto;padding:12px 16px}
  .brand{font-weight:800}.spacer{flex:1}
  .btn{cursor:pointer;min-height:48px;padding:10px 14px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:800;box-shadow:var(--shadow)}
  .btn.ghost{background:#e2f2fb;color:#0369a1}.btn.ok{background:var(--ok)}.btn.warn{background:var(--warn)}.btn.danger{background:var(--danger)}
  .btn.sm{min-height:36px;padding:6px 10px;font-weight:700}
  main{max-width:1000px;margin:8px auto 80px;padding:12px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .headline{display:flex;align-items:center;gap:8px}
  .remain{font-size:32px;font-weight:900}.depart{font-size:14px;color:var(--muted)} .depart strong{color:var(--fg)}
  .now{display:flex;gap:10px;align-items:center;margin-top:8px}.now h3{margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .list{background:#f1f5f9;border-radius:12px;padding:8px;margin-top:12px}
  .task{display:flex;align-items:center;gap:10px;background:#fff;border-radius:12px;padding:10px;margin:6px 0;box-shadow:var(--shadow)}
  .drag{cursor:grab;opacity:.8}
  /* iOS12ç”¨ï¼šdialogç°¡æ˜“ãƒãƒªãƒ•ã‚£ãƒ«ã®è¦‹ãŸç›® */
  dialog{border:none;border-radius:14px;box-shadow:var(--shadow);max-width:560px;width:96%;padding:16px;background:#fff}
  dialog:not([open]){display:none}
  dialog[open]{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1000}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  input,select{min-height:44px;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1}
  .hint{font-size:13px;color:var(--muted)}
  .badge{position:fixed;right:8px;bottom:8px;font-size:12px;opacity:.6}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">ğŸŒ… æœã®ã˜ã‚…ã‚“ã³ã‚³ãƒ¼ãƒï¼ˆç°¡æ˜“1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</div>
    <div class="spacer"></div>
    <button id="btnParent" class="btn ghost">è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
  </div>
</header>

<main class="grid">
  <!-- 6æ­³ -->
  <section id="p_k6" class="card" aria-labelledby="h6">
    <div class="headline"><h2 id="h6">6æ­³ï¼ˆå°å­¦ç”Ÿï¼‰</h2><div id="stars_k6" style="margin-left:auto">â­0</div></div>
    <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap">
      <div class="remain" id="rem_k6">--:--</div>
      <div class="depart" id="dep_k6">å‡ºç™º <strong>07:55</strong>ï¼ˆé•·æŠ¼ã—ã§ç·¨é›†ï¼‰</div>
    </div>
    <div class="hint">ã€Œã¯ã˜ã‚ã‚‹ã€ã‚’æŠ¼ã™ã¨éŸ³å£°ã‚¬ã‚¤ãƒ‰é–‹å§‹</div>
    <div class="now"><div style="font-size:24px">ğŸŒ</div><div><h3 id="now_k6">èµ·åºŠ</h3><div id="meta_k6" class="hint">æ‰€è¦ 1åˆ† / ã‚¿ãƒƒãƒ—</div></div></div>
    <div class="controls" id="ctrl_k6">
      <button class="btn ok" data-cmd="done"  data-id="kid_6">ã§ããŸï¼</button>
      <button class="btn ghost" data-cmd="hint" data-id="kid_6">ã‚ã‹ã‚‰ãªã„</button>
      <button class="btn warn" data-cmd="skip" data-id="kid_6">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¦ªï¼‰</button>
      <button class="btn"      data-cmd="begin" data-id="kid_6">ã¯ã˜ã‚ã‚‹</button>
      <button class="btn ghost" data-cmd="add" data-id="kid_6">ï¼‹ã‚¿ã‚¹ã‚¯</button>
    </div>
    <div id="next_k6" class="hint" style="margin-top:6px">ã¤ãï¼šâ€”</div>
    <div id="list_k6" class="list" aria-label="ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆ"></div>
  </section>

  <!-- 3æ­³ -->
  <section id="p_k3" class="card" aria-labelledby="h3">
    <div class="headline"><h2 id="h3">3æ­³ï¼ˆä¿è‚²åœ’ï¼‰</h2><div id="stars_k3" style="margin-left:auto">â­0</div></div>
    <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap">
      <div class="remain" id="rem_k3">--:--</div>
      <div class="depart" id="dep_k3">å‡ºç™º <strong>09:00</strong>ï¼ˆé•·æŠ¼ã—ã§ç·¨é›†ï¼‰</div>
    </div>
    <div class="hint">ã€Œã¯ã˜ã‚ã‚‹ã€ã‚’æŠ¼ã™ã¨éŸ³å£°ã‚¬ã‚¤ãƒ‰é–‹å§‹</div>
    <div class="now"><div style="font-size:24px">ğŸŒ</div><div><h3 id="now_k3">èµ·åºŠ</h3><div id="meta_k3" class="hint">æ‰€è¦ 1åˆ† / ã‚¿ãƒƒãƒ—</div></div></div>
    <div class="controls" id="ctrl_k3">
      <button class="btn ok" data-cmd="done"  data-id="kid_3">ã§ããŸï¼</button>
      <button class="btn ghost" data-cmd="hint" data-id="kid_3">ã‚ã‹ã‚‰ãªã„</button>
      <button class="btn warn" data-cmd="skip" data-id="kid_3">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¦ªï¼‰</button>
      <button class="btn"      data-cmd="begin" data-id="kid_3">ã¯ã˜ã‚ã‚‹</button>
      <button class="btn ghost" data-cmd="add" data-id="kid_3">ï¼‹ã‚¿ã‚¹ã‚¯</button>
    </div>
    <div id="next_k3" class="hint" style="margin-top:6px">ã¤ãï¼šâ€”</div>
    <div id="list_k3" class="list" aria-label="ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆ"></div>
  </section>
</main>

<!-- è¦ªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆiOS12ã¯ç°¡æ˜“ãƒãƒªãƒ•ã‚£ãƒ«ã§è¡¨ç¤ºï¼‰ -->
<dialog id="dlgParent">
  <form method="dialog">
    <h3>è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
    <div class="field">
      <label>å¯¾è±¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
      <select id="selProfile"><option value="kid_6">6æ­³</option><option value="kid_3">3æ­³</option></select>
    </div>
    <div class="field"><label>å‡ºç™ºæ™‚åˆ»ï¼ˆä»Šæ—¥ã ã‘ï¼‰</label><input id="overrideTime" placeholder="ä¾‹ 07:55"></div>
    <div class="field"><label>å­¦å¹´ï¼ˆ0=æœªå°±å­¦, 1ã€œ6ï¼‰</label><input id="gradeInput" type="number" min="0" max="6" step="1" value="1"></div>
    <div class="field"><label>è¦ªPINï¼ˆç©ºãªã‚‰ç„¡åŠ¹ï¼‰</label><input id="pinInput" inputmode="numeric" maxlength="4" placeholder="1234"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnExport" class="btn ghost" type="button">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <input id="fileImport" type="file" accept="application/json">
      <button class="btn" type="button" id="btnCloseParent">ã¨ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›† -->
<dialog id="dlgTask">
  <form method="dialog">
    <h3>ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†</h3>
    <div class="field"><label>åå‰ï¼ˆå¿…é ˆï¼‰</label><input id="taskName"></div>
    <div class="field"><label>æ‰€è¦åˆ†ï¼ˆ0.5ã€œ30ï¼‰</label><input id="taskMin" type="number" step="0.5" min="0.5" max="30" value="1"></div>
    <div class="field"><label>æ–¹å¼</label><select id="taskMode"><option value="tap">ã‚¿ãƒƒãƒ—</option><option value="timer">ã‚¿ã‚¤ãƒãƒ¼</option></select></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnDelTask" class="btn danger" type="button">å‰Šé™¤</button>
      <button id="btnSaveTask" class="btn ok" type="button">ä¿å­˜</button>
      <button class="btn" type="button" id="btnCloseTask">ã¨ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<div class="badge">build: simple-1file-r5-ios12</div>

<script type="module">
/* ===== iOS12å‘ã‘ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£/ãƒãƒªãƒ•ã‚£ãƒ« ===== */
function deepCopy(obj){ try{return JSON.parse(JSON.stringify(obj))}catch(e){return {}}; }
function _matches(el,sel){
  var fn = el.matches || el.webkitMatchesSelector || el.msMatchesSelector;
  return fn ? fn.call(el,sel) : false;
}
function closestEl(el,sel){ while(el && el.nodeType===1){ if(_matches(el,sel)) return el; el=el.parentElement; } return null; }
(function polyfillDialog(){
  var ds=document.querySelectorAll('dialog');
  for(var i=0;i<ds.length;i++){
    var d=ds[i];
    if(!d.showModal){ d.showModal=function(){ this.setAttribute('open',''); }; d.close=function(){ this.removeAttribute('open'); }; }
  }
})();

/* ===== 1) ãƒ‡ãƒ¼ã‚¿ ===== */
var KEY='mc.simple.v1';
var defaultState={
  profiles:{
    kid_6:{name:'6æ­³',age:6,schoolGrade:1,targetDeparture:'07:55',todayOverride:null,stars:0,tasks:[
      {id:'wake',label:'èµ·åºŠ',minutes:1,mode:'tap'},{id:'toilet',label:'ãƒˆã‚¤ãƒ¬',minutes:3,mode:'timer'},
      {id:'wash',label:'é¡”ã‚’æ´—ã†',minutes:2,mode:'tap'},{id:'tooth',label:'æ­¯ã¿ãŒã',minutes:2,mode:'timer'},
      {id:'dress',label:'ç€æ›¿ãˆ',minutes:3,mode:'tap'},{id:'bag',label:'æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯',minutes:2,mode:'tap'},
      {id:'rice',label:'æœã”ã¯ã‚“',minutes:10,mode:'timer'},{id:'clean',label:'ç‰‡ä»˜ã‘',minutes:2,mode:'tap'},
      {id:'run',label:'å‡ºç™ºæº–å‚™',minutes:1,mode:'tap'},
    ]},
    kid_3:{name:'3æ­³',age:3,schoolGrade:0,targetDeparture:'09:00',todayOverride:null,stars:0,tasks:[
      {id:'wake',label:'èµ·åºŠ',minutes:1,mode:'tap'},{id:'toilet_assist',label:'ãƒˆã‚¤ãƒ¬ï¼ˆè£œåŠ©ï¼‰',minutes:4,mode:'timer'},
      {id:'wipe_face',label:'é¡”ã‚’æ‹­ã',minutes:2,mode:'tap'},{id:'tooth',label:'æ­¯ã¿ãŒãï¼ˆè£œåŠ©ï¼‰',minutes:2,mode:'timer'},
      {id:'dress',label:'ç€æ›¿ãˆ',minutes:3,mode:'tap'},{id:'socks',label:'é´ä¸‹',minutes:1,mode:'tap'},
      {id:'rice',label:'æœã”ã¯ã‚“',minutes:12,mode:'timer'},{id:'clean',label:'ç‰‡ä»˜ã‘',minutes:2,mode:'tap'},
      {id:'run',label:'å‡ºç™ºæº–å‚™',minutes:1,mode:'tap'},
    ]},
  },
  settings:{pin:'',ttsRate:1.0}
};
function load(){ try{var r=localStorage.getItem(KEY); return r? JSON.parse(r):deepCopy(defaultState);}catch(e){return deepCopy(defaultState)} }
var state=load();
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* ===== 2) å­¦å¹´æœªæº€ã¯ã‹ãªã«ã™ã‚‹ ===== */
var KANJI_GRADE={'æœ':2,'æ­³':99,'å°':1,'å­¦':1,'ç”Ÿ':1,'é…':99,'åˆ†':2,'èµ·':3,'åºŠ':99,'æ‰€':3,'è¦':4,'æ™‚':2,'é–“':2,'åŒ':2,'é¡”':2,'æ´—':6,'æ­¯':3,'ç€':3,'æ›¿':99,'æŒ':3,'ç‰©':3,'ç‰‡':6,'ä»˜':4,'å‡º':1,'ç™º':3,'æº–':5,'å‚™':5};
var PHRASE={'å‡ºç™ºæº–å‚™':'ã§ã‹ã‘ã‚‹ã˜ã‚…ã‚“ã³','èµ·åºŠ':'ãŠãã‚‹','åŒæ™‚':'ã„ã£ã—ã‚‡','æ‰€è¦':'ã˜ã‹ã‚“','é…ã‚Œ':'ãŠãã‚Œ','ç€æ›¿ãˆ':'ããŒãˆ','æŒã¡ç‰©':'ã‚‚ã¡ã‚‚ã®','ç‰‡ä»˜ã‘':'ã‹ãŸã¥ã‘','æœ':'ã‚ã•','æ™‚é–“':'ã˜ã‹ã‚“','æ´—ã†':'ã‚ã‚‰ã†','é¡”':'ã‹ãŠ','æ­¯':'ã¯','å°å­¦ç”Ÿ':'ã—ã‚‡ã†ãŒãã›ã„','æ°—åˆ†':'ãã¶ã‚“'};
var CHAR={'æœ':'ã‚ã•','æ­³':'ã•ã„','é…':'ãŠã','åˆ†':'ãµã‚“','èµ·':'ãŠ','åºŠ':'ã‚†ã‹','æ‰€':'ã¨ã“ã‚','è¦':'ã‚ˆã†','æ™‚':'ã˜','é–“':'ã¾','åŒ':'ãŠãªã˜','é¡”':'ã‹ãŠ','æ´—':'ã‚ã‚‰','æ­¯':'ã¯','ç€':'ã','æ›¿':'ã‹','æŒ':'ã‚‚','ç‰©':'ã‚‚ã®','ç‰‡':'ã‹ãŸ','ä»˜':'ã¤','å‡º':'ã§','ç™º':'ã¯ã¤','æº–':'ã˜ã‚…ã‚“','å‚™':'ã³'};
function isKanji(ch){ return /[\u4E00-\u9FFF]/.test(ch); }
function kgrade(ch){ return KANJI_GRADE[ch]!=null? KANJI_GRADE[ch]:99; }
function toKanaByGrade(text,grade){
  var out=text;
  for(var p in PHRASE){ if(out.indexOf(p)>=0){
    var tooHard=false; for(var i=0;i<p.length;i++){ var c=p.charAt(i); if(isKanji(c)&&kgrade(c)>grade){tooHard=true;break;} }
    if(tooHard||grade===0) out=out.split(p).join(PHRASE[p]);
  }}
  var rs=''; for(var j=0;j<out.length;j++){ var ch=out.charAt(j); rs += (isKanji(ch)&&(kgrade(ch)>grade||grade===0)) ? (CHAR[ch]||ch) : ch; }
  return rs;
}

/* ===== 3) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function qs(s,root){ return (root||document).querySelector(s); }
function hhmmToMin(s){ var a=s.split(':'); return (parseInt(a[0],10)||0)*60+(parseInt(a[1],10)||0); }
function nowMinTokyo(){ var s=new Intl.DateTimeFormat('en-GB',{timeZone:'Asia/Tokyo',hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date()); var a=s.split(':'); return (parseInt(a[0],10)||0)*60+(parseInt(a[1],10)||0); }

/* ===== 4) éŸ³å£°ï¼ˆTTSï¼‰ ===== */
var vJA=null; function pickVoice(){ var vs=speechSynthesis.getVoices(); vJA=(vs||[]).find(function(v){return /ja-JP/i.test(v.lang)})||(vs||[]).find(function(v){return /ja/i.test(v.lang)})||null; }
speechSynthesis.addEventListener('voiceschanged', pickVoice); pickVoice();
function speak(t){ var u=new SpeechSynthesisUtterance(t); if(vJA)u.voice=vJA; u.lang='ja-JP'; u.rate=state.settings.ttsRate; try{speechSynthesis.cancel()}catch(e){} speechSynthesis.speak(u); }
function speakSeq(parts){
  try{ speechSynthesis.cancel(); }catch(e){}
  var i=0; (function play(){ if(i>=parts.length) return; var seg=parts[i++]; var u=new SpeechSynthesisUtterance(seg.text); if(vJA)u.voice=vJA; u.lang='ja-JP'; u.rate=seg.rate!=null?seg.rate:state.settings.ttsRate; u.pitch=seg.pitch!=null?seg.pitch:1.0; speechSynthesis.speak(u); u.onend=play; })();
}

/* ===== 5) æç”» ===== */
function prof(id){ return state.profiles[id]; }
function depTime(p){ return p.todayOverride || p.targetDeparture; }
function remainMin(p){ return hhmmToMin(depTime(p)) - nowMinTokyo(); }

function renderOne(id){
  var p=prof(id); var g=p.schoolGrade;
  qs(id==='kid_6'?'#h6':'#h3').textContent = p.age<=3 ? '3ã•ã„ï¼ˆã»ã„ããˆã‚“ï¼‰' : '6ã•ã„ï¼ˆã—ã‚‡ã†ãŒãã›ã„ï¼‰';
  var depLbl = toKanaByGrade('å‡ºç™º',g).replace('å‡ºç™º','ã§ã‚‹ã˜ã‹ã‚“');
  qs(id==='kid_6'?'#dep_k6':'#dep_k3').innerHTML = depLbl+' <strong>'+depTime(p)+'</strong>ï¼ˆé•·æŠ¼ã—ã§ç·¨é›†ï¼‰';
  var r=remainMin(p); qs(id==='kid_6'?'#rem_k6':'#rem_k3').textContent = r>=0? (('0'+Math.floor(r/60)).slice(-2)+':'+('0'+(r%60)).slice(-2)) : toKanaByGrade('é…ã‚Œ '+Math.abs(r)+'åˆ†', g);
  var now = p.tasks[0];
  qs(id==='kid_6'?'#now_k6':'#now_k3').textContent = now? toKanaByGrade(now.label,g): toKanaByGrade('ã™ã¹ã¦å®Œäº†ï¼',g);
  qs(id==='kid_6'?'#meta_k6':'#meta_k3').textContent = now? toKanaByGrade('æ‰€è¦ '+now.minutes+'åˆ† / '+(now.mode==='timer'?'ã‚¿ã‚¤ãƒãƒ¼':'ã‚¿ãƒƒãƒ—'), g):'';
  qs(id==='kid_6'?'#next_k6':'#next_k3').textContent = p.tasks[1]? toKanaByGrade('ã¤ãï¼šã€Œ'+p.tasks[1].label+'ã€ / '+p.tasks[1].minutes+'åˆ†', g) : 'ã¤ãï¼šâ€”';
  qs(id==='kid_6'?'#stars_k6':'#stars_k3').textContent = 'â­'+(p.stars||0);

  var list=qs(id==='kid_6'?'#list_k6':'#list_k3'); list.innerHTML='';
  p.tasks.forEach(function(t,idx){
    var el=document.createElement('div'); el.className='task'; el.draggable=true; el.setAttribute('data-index',idx);
    el.innerHTML =
      '<div class="drag" title="â†•">â†•</div>'+
      '<div style="flex:1"><strong>'+toKanaByGrade(t.label,g)+'</strong><div class="hint">'+t.minutes+'åˆ† / '+(t.mode==='timer'?'ã‚¿ã‚¤ãƒãƒ¼':'ã‚¿ãƒƒãƒ—')+'</div></div>'+
      '<div style="display:flex;gap:6px;align-items:center">'+
        '<button class="btn ghost sm" data-move="up" data-idx="'+idx+'" data-id="'+id+'">â–²</button>'+
        '<button class="btn ghost sm" data-move="down" data-idx="'+idx+'" data-id="'+id+'">â–¼</button>'+
      '</div>'+
      '<button class="btn ghost" data-edit="'+idx+'" data-id="'+id+'">ç·¨é›†</button>';
    list.appendChild(el);
  });

  // DnDï¼ˆPCå‘ã‘ï¼‰
  var dragIdx=null;
  list.ondragstart=function(e){ var box=closestEl(e.target,'.task'); dragIdx=box?Number(box.getAttribute('data-index')):null; };
  list.ondragover=function(e){ e.preventDefault(); };
  list.ondrop=function(e){
    e.preventDefault(); var target=closestEl(e.target,'.task'); if(!target) return;
    var dropIdx=Number(target.getAttribute('data-index')); if(dropIdx===dragIdx||dragIdx==null) return;
    var arr=p.tasks; var m=arr.splice(dragIdx,1)[0]; arr.splice(dropIdx,0,m); save(); renderOne(id);
  };

  // ã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼â–²â–¼ã§ä¸¦ã¹æ›¿ãˆ
  list.onclick=function(e){
    var mv=closestEl(e.target,'button[data-move]'); 
    if(mv){
      var dir=mv.getAttribute('data-move'), idx=Number(mv.getAttribute('data-idx')); 
      var arr=p.tasks, to=dir==='up'? idx-1:idx+1;
      if(to>=0 && to<arr.length){ var tmp=arr[idx]; arr.splice(idx,1); arr.splice(to,0,tmp); save(); renderOne(id); }
      return;
    }
    var b=closestEl(e.target,'button[data-edit]'); if(!b) return;
    openTaskEditor(id, Number(b.getAttribute('data-edit')));
  };
}

function tick(){ ['kid_6','kid_3'].forEach(renderOne); }
setInterval(tick,1000); tick();

/* ===== 6) ã‚¯ãƒªãƒƒã‚¯æ“ä½œ ===== */
document.body.addEventListener('click',function(e){
  var btn=closestEl(e.target,'button'); if(!btn) return;
  var cmd=btn.getAttribute('data-cmd'), id=btn.getAttribute('data-id');
  if(cmd==='begin'){
    var g=prof(id).schoolGrade;
    try{ speechSynthesis.speak(new SpeechSynthesisUtterance(' ')); }catch(ex){} // iOS12: ç„¡éŸ³ã§èµ·ã“ã™
    var say=[
      { text: toKanaByGrade('ãŠã¯ã‚ˆã†ï¼', g), rate:1.05, pitch:1.2 },
      { text: toKanaByGrade('ãã‚‡ã†ã® ãã¶ã‚“ã¯ã€', g) },
      { text: toKanaByGrade('ã‚ãã‚ãã€', g) },
      { text: toKanaByGrade('ã­ã‚€ã„ã€', g) },
      { text: toKanaByGrade('ãµã¤ã†ã€', g) },
      { text: toKanaByGrade('ã‹ã‚‰ ãˆã‚‰ã‚“ã§ã­ï¼', g), pitch:1.15 }
    ];
    speakSeq(say);
  }
  if(cmd==='done'){
    var p=prof(id); if(!p.tasks.length) return; var t=p.tasks.shift();
    p.stars=(p.stars||0)+1; save(); renderOne(id);
    var g2=p.schoolGrade, nextLabel=p.tasks[0]?p.tasks[0].label:'ãŠã—ã¾ã„';
    speak(toKanaByGrade('ã€Œ'+t.label+'ã€ã§ããŸï¼ã¤ãã¯ã€Œ'+nextLabel+'ã€ã ã‚ˆã€‚', g2));
  }
  if(cmd==='hint'){
    var p2=prof(id); var g3=p2.schoolGrade; var t2=p2.tasks[0];
    speak(toKanaByGrade(t2? (t2.label+' ã®ãƒ’ãƒ³ãƒˆã ã‚ˆã€‚ã‚†ã£ãã‚Šã§ã ã„ã˜ã‚‡ã†ã¶ï¼') : 'ã„ã£ã—ã‚‡ã« ã™ã™ã‚‚ã†ï¼', g3));
  }
  if(cmd==='skip'){
    var pin=state.settings.pin; if(pin){ var x=prompt('è¦ªPINã‚’å…¥åŠ›'); if(x!==pin) return alert('PINãŒé•ã„ã¾ã™'); }
    var p3=prof(id); if(!p3.tasks.length) return; p3.tasks.shift(); save(); renderOne(id);
  }
  if(cmd==='add'){ openTaskEditor(id,-1); }
});

/* ===== 7) å‡ºç™ºæ™‚åˆ»ï¼ˆé•·æŠ¼ã—ç·¨é›†ï¼‰ ===== */
[['#dep_k6','kid_6'],['#dep_k3','kid_3']].forEach(function(pair){
  var sel=pair[0], id=pair[1]; var el=qs(sel); var t=null;
  el.addEventListener('mousedown',function(){ t=setTimeout(function(){ editTime(id); },500); });
  el.addEventListener('mouseup',function(){ clearTimeout(t); });
  el.addEventListener('touchstart',function(){ t=setTimeout(function(){ editTime(id); },500); },{passive:true});
  el.addEventListener('touchend',function(){ clearTimeout(t); });
});
function editTime(id){
  var v=prompt('å‡ºç™ºæ™‚åˆ»ï¼ˆHH:MMï¼‰', depTime(prof(id)));
  if(!v) return; if(!/^\d{2}:\d{2}$/.test(v)) return alert('HH:MM å½¢å¼');
  prof(id).todayOverride=v; save(); renderOne(id);
}

/* ===== 8) è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ & ã‚¿ã‚¹ã‚¯ç·¨é›† ===== */
var dlgParent=qs('#dlgParent'), dlgTask=qs('#dlgTask');
qs('#btnParent').onclick=function(){ dlgParent.showModal(); };
qs('#btnCloseParent').onclick=function(){ dlgParent.close(); };
qs('#selProfile').onchange=function(){ var id=this.value; var p=prof(id); qs('#gradeInput').value=String(p.schoolGrade||0); qs('#overrideTime').value=p.todayOverride||''; };
qs('#gradeInput').onchange=function(){ var id=qs('#selProfile').value; var v=Number(this.value||'0'); if(v<0||v>6) return alert('0ã€œ6'); prof(id).schoolGrade=v; save(); renderOne(id); };
qs('#overrideTime').onchange=function(){ var id=qs('#selProfile').value; var v=this.value.trim(); prof(id).todayOverride=v||null; save(); renderOne(id); };
qs('#pinInput').onchange=function(){ state.settings.pin=this.value.trim(); save(); };

qs('#btnExport').onclick=function(){ var blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='morningCoach_backup.json'; a.click(); };
qs('#fileImport').onchange=function(e){ var f=e && e.target && e.target.files && e.target.files[0]; if(!f) return; f.text().then(function(txt){ try{ state=JSON.parse(txt); save(); location.reload(); }catch(err){ alert('JSONå½¢å¼ã‚¨ãƒ©ãƒ¼'); } }); };
qs('#btnCloseTask').onclick=function(){ dlgTask.close(); };

var taskCtx={id:'kid_6',idx:-1};
function openTaskEditor(id,idx){
  taskCtx={id:id,idx:idx};
  var isNew=(idx===-1), p=prof(id), ex=p.tasks[idx]||null;
  qs('#taskName').value=isNew?'':(ex?ex.label:'');
  qs('#taskMin').value=isNew?'1':String(ex?ex.minutes:1);
  qs('#taskMode').value=isNew?'tap':(ex?ex.mode:'tap');
  dlgTask.showModal();
}
qs('#btnSaveTask').onclick=function(){
  var name=qs('#taskName').value.trim(); var minutes=Number(qs('#taskMin').value); var mode=qs('#taskMode').value;
  if(!name) return alert('åå‰ã¯å¿…é ˆ'); if(!(minutes>=0.5&&minutes<=30)) return alert('0.5ã€œ30ã§å…¥åŠ›');
  var arr=prof(taskCtx.id).tasks;
  if(taskCtx.idx===-1){ arr.push({id:'t_'+Date.now(),label:name,minutes:minutes,mode:mode}); }
  else{ var tgt=arr[taskCtx.idx]; tgt.label=name; tgt.minutes=minutes; tgt.mode=mode; }
  save(); renderOne(taskCtx.id); dlgTask.close();
};
qs('#btnDelTask').onclick=function(){
  if(taskCtx.idx===-1){ dlgTask.close(); return; }
  var arr=prof(taskCtx.id).tasks; arr.splice(taskCtx.idx,1); save(); renderOne(taskCtx.id); dlgTask.close();
};

/* ===== 9) ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« file:// ã§ã¯SWã¯ç„¡åŠ¹ã€‚å…¬é–‹å¾Œã«æœ‰åŠ¹åŒ–äºˆå®šï¼‰ ===== */
</script>
</body>
</html>
