<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã‚ã•ã®ã˜ã‚…ã‚“ã³ã‚³ãƒ¼ãƒ</title>
  <!-- iOS A2HSé‡è¦– -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- æœ€ä½é™ã®apple-touch-iconï¼ˆå·®ã—æ›¿ãˆå¯ï¼‰ -->
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-180.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">

  <style>
    :root{
      --bg:#f7fafc; --fg:#0f172a; --muted:#475569; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --card:#ffffff; --shadow:0 6px 20px rgba(2,6,23,0.07);
      --tap:56px; --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
      color:var(--fg); background:var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      background:linear-gradient(180deg, rgba(247,250,252,.9), rgba(247,250,252,.6));
      border-bottom:1px solid #e5e7eb;
    }
    .bar{
      max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px;
    }
    .brand{ font-weight:800; letter-spacing:.02em;}
    .spacer{flex:1}
    .pill{padding:8px 12px; border-radius:999px; background:#e2f2fb; color:#0369a1; font-weight:700}
    .btn{cursor:pointer; padding:12px 16px; border-radius:12px; border:none; background:var(--brand); color:#fff; font-weight:800; box-shadow:var(--shadow); min-height:var(--tap)}
    .btn.ghost{background:#e2f2fb; color:#0369a1}
    .btn.warn{background:var(--warn)}
    .btn.ok{background:var(--ok)}
    .btn.danger{background:var(--danger)}
    .tabs{display:flex; gap:8px; padding:8px 16px}
    .tab{flex:1; text-align:center; padding:10px 12px; border-radius:999px; background:#e2e8f0; font-weight:700; cursor:pointer}
    .tab.active{background:var(--brand); color:#fff}

    main{max-width:1200px; margin:8px auto 80px; padding:12px}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1024px){
      .grid.split{grid-template-columns: 1fr 1fr;}
    }
    .card{
      background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); min-height:280px;
    }
    .headline{display:flex; align-items:center; gap:12px}
    .timebox{
      display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;
    }
    .remain{font-size:36px; font-weight:900}
    .depart{font-size:14px; color:var(--muted)}
    .depart strong{font-size:18px; color:var(--fg)}
    .hint{font-size:13px; color:var(--muted)}
    .nowtask{
      margin-top:12px; display:flex; gap:12px; align-items:center;
    }
    .nowtask .icon{width:56px; height:56px; border-radius:16px; background:#e2f2fb; display:grid; place-items:center}
    .nowtask h3{margin:0; font-size:22px}
    .controls{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .next{margin-top:8px; font-size:14px; color:var(--muted)}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .stars{margin-left:auto; font-weight:800; color:#f59e0b}
    .editbar{display:flex; gap:8px; align-items:center}
    .editlink{cursor:pointer; color:#0369a1; text-decoration:underline}
    .list{margin-top:10px; padding:8px; border-radius:12px; background:#f1f5f9; min-height:80px}
    .taskitem{
      display:flex; align-items:center; gap:10px; background:#fff; border-radius:12px; padding:10px; margin:6px 0; box-shadow:var(--shadow);
    }
    .drag{cursor:grab; opacity:.8}
    .taskmeta{font-size:13px; color:var(--muted)}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; background:rgba(247,250,252,.9); backdrop-filter:blur(6px);
      border-top:1px solid #e5e7eb; padding:12px 16px; display:flex; gap:8px; align-items:center; justify-content:center;
    }
    dialog{border:none; border-radius:16px; box-shadow:var(--shadow); max-width:680px; width:96%}
    dialog::backdrop{background:rgba(2,6,23,.3)}
    .field{display:flex; flex-direction:column; gap:6px; margin:8px 0}
    input, select{
      padding:12px 14px; border-radius:12px; border:1px solid #d1d5db; font-size:16px; min-height:48px;
      background:#fff;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:8px 10px; border-radius:999px; background:#e2e8f0; cursor:pointer}
    .chip.active{background:#0ea5e9; color:#fff}
    .sr-only{position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">ğŸŒ… æœã®ã˜ã‚…ã‚“ã³ã‚³ãƒ¼ãƒ</div>
    <div id="modePill" class="pill">iPhone:ã‚¿ãƒ– / iPad:åˆ†å‰²</div>
    <div class="spacer"></div>
    <button id="btnParent" class="btn ghost" aria-label="è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
  </div>
  <!-- iPhoneç”¨ã‚¿ãƒ–ï¼ˆå°ç”»é¢æ™‚ã®ã¿æœ‰åŠ¹ï¼‰ -->
  <div id="tabs" class="tabs" role="tablist" aria-label="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åˆ‡æ›¿">
    <div class="tab active" data-target="kid_6" role="tab" aria-selected="true">6æ­³</div>
    <div class="tab" data-target="kid_3" role="tab" aria-selected="false">3æ­³</div>
  </div>
</header>

<main>
  <section id="home" class="grid split">
    <!-- 6æ­³ãƒ‘ãƒãƒ« -->
    <article id="panel_kid_6" class="card" aria-labelledby="h_kid6">
      <div class="headline">
        <h2 id="h_kid6">6æ­³ï¼ˆå°å­¦ç”Ÿï¼‰</h2>
        <div class="stars" id="stars_kid_6">â­0</div>
      </div>
      <div class="timebox">
        <div class="remain" id="remain_kid_6">--:--</div>
        <div class="depart" id="depart_kid_6" title="é•·æŠ¼ã—ã§ç·¨é›†">
          å‡ºç™º <strong>07:55</strong>ï¼ˆé•·æŠ¼ã—ã§ç·¨é›†ï¼‰
        </div>
      </div>
      <div class="hint">ã¯ã˜ã‚ã¯ã€Œã¯ã˜ã‚ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼ˆéŸ³å£°ã‚¬ã‚¤ãƒ‰ãŒã¯ã˜ã¾ã‚‹ã‚ˆï¼‰</div>
      <div class="nowtask">
        <div class="icon" aria-hidden="true"><svg width="28" height="28"><use href="#i-sun"/></svg></div>
        <div>
          <h3 id="now_kid_6">èµ·åºŠ</h3>
          <div class="taskmeta" id="meta_kid_6">æ‰€è¦ 1åˆ† / ãƒ¢ãƒ¼ãƒ‰:ã‚¿ãƒƒãƒ—</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn ok" data-cmd="done" data-profile="kid_6">ã§ããŸï¼</button>
        <button class="btn ghost" data-cmd="hint" data-profile="kid_6">ã‚ã‹ã‚‰ãªã„</button>
        <button class="btn warn" data-cmd="skip" data-profile="kid_6">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¦ªï¼‰</button>
        <button class="btn" data-cmd="begin" data-profile="kid_6">ã¯ã˜ã‚ã‚‹</button>
        <button class="btn ghost" data-cmd="simple" data-profile="kid_6">ã‚«ãƒ³ã‚¿ãƒ³ç‰ˆ</button>
      </div>
      <div class="next" id="next_kid_6">ã¤ãï¼šâ€”</div>

      <div class="editbar" style="margin-top:10px">
        <span class="editlink" data-edit="tasks" data-profile="kid_6">ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ã™ã‚‹</span>
        <span class="editlink" data-edit="export" data-profile="kid_6">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
        <span class="editlink" data-edit="import" data-profile="kid_6">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
      </div>

      <div class="list" id="list_kid_6" aria-label="ã‚¿ã‚¹ã‚¯ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆ"></div>
    </article>

    <!-- 3æ­³ãƒ‘ãƒãƒ« -->
    <article id="panel_kid_3" class="card" aria-labelledby="h_kid3">
      <div class="headline">
        <h2 id="h_kid3">3æ­³ï¼ˆä¿è‚²åœ’ï¼‰</h2>
        <div class="stars" id="stars_kid_3">â­0</div>
      </div>
      <div class="timebox">
        <div class="remain" id="remain_kid_3">--:--</div>
        <div class="depart" id="depart_kid_3" title="é•·æŠ¼ã—ã§ç·¨é›†">
          å‡ºç™º <strong>09:00</strong>ï¼ˆé•·æŠ¼ã—ã§ç·¨é›†ï¼‰
        </div>
      </div>
      <div class="hint">ã€Œã¯ã˜ã‚ã‚‹ã€ã§éŸ³å£°ã‚¬ã‚¤ãƒ‰ã‚’é–‹å§‹</div>
      <div class="nowtask">
        <div class="icon" aria-hidden="true"><svg width="28" height="28"><use href="#i-sun"/></svg></div>
        <div>
          <h3 id="now_kid_3">èµ·åºŠ</h3>
          <div class="taskmeta" id="meta_kid_3">æ‰€è¦ 1åˆ† / ãƒ¢ãƒ¼ãƒ‰:ã‚¿ãƒƒãƒ—</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn ok" data-cmd="done" data-profile="kid_3">ã§ããŸï¼</button>
        <button class="btn ghost" data-cmd="hint" data-profile="kid_3">ã‚ã‹ã‚‰ãªã„</button>
        <button class="btn warn" data-cmd="skip" data-profile="kid_3">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¦ªï¼‰</button>
        <button class="btn" data-cmd="begin" data-profile="kid_3">ã¯ã˜ã‚ã‚‹</button>
        <button class="btn ghost" data-cmd="simple" data-profile="kid_3">ã‚«ãƒ³ã‚¿ãƒ³ç‰ˆ</button>
      </div>
      <div class="next" id="next_kid_3">ã¤ãï¼šâ€”</div>

      <div class="editbar" style="margin-top:10px">
        <span class="editlink" data-edit="tasks" data-profile="kid_3">ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ã™ã‚‹</span>
        <span class="editlink" data-edit="export" data-profile="kid_3">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
        <span class="editlink" data-edit="import" data-profile="kid_3">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
      </div>

      <div class="list" id="list_kid_3" aria-label="ã‚¿ã‚¹ã‚¯ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆ"></div>
    </article>
  </section>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
<dialog id="dlgParent">
  <form method="dialog">
    <h3>è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
    <div class="field">
      <label>å¯¾è±¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
      <select id="parentProfileSel">
        <option value="kid_6">6æ­³ï¼ˆå°å­¦ç”Ÿï¼‰</option>
        <option value="kid_3">3æ­³ï¼ˆä¿è‚²åœ’ï¼‰</option>
      </select>
    </div>

    <div class="field">
      <label>ã‚¯ã‚¤ãƒƒã‚¯å‡ºç™ºæ™‚åˆ»</label>
      <div class="chips">
        <span class="chip" data-qtime="07:30">07:30</span>
        <span class="chip" data-qtime="07:55">07:55</span>
        <span class="chip" data-qtime="08:30">08:30</span>
        <span class="chip" data-qtime="09:00">09:00</span>
      </div>
    </div>

    <div class="field">
      <label>æ›œæ—¥åˆ¥ï¼ˆä¾‹ï¼šMon=æœˆï¼‰ / æœ¬æ—¥ä¸€æ™‚å¤‰æ›´</label>
      <div><input id="byWeekdayInput" placeholder='{"Mon":"07:55",...}'></div>
      <div><input id="todayOverrideInput" placeholder="æœ¬æ—¥ã ã‘ä¾‹: 08:10"></div>
    </div>

    <div class="field">
      <label>è¦ªPINï¼ˆ4æ¡ã€‚ç©ºãªã‚‰ç„¡åŠ¹ï¼‰</label>
      <input id="parentPinInput" inputmode="numeric" maxlength="4" placeholder="1234">
    </div>

    <div class="field">
      <label>JSON ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
      <div class="row">
        <button id="btnExportAll" class="btn ghost" type="button">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå…¨ä½“ï¼‰</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>
    </div>

    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
      <button id="btnCacheUpdate" class="btn warn" type="button">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°</button>
      <button class="btn">ã¨ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›† -->
<dialog id="dlgTask">
  <form method="dialog">
    <h3>ã‚¿ã‚¹ã‚¯ã®è¿½åŠ /ç·¨é›†</h3>
    <div class="field"><label>åå‰ï¼ˆå¿…é ˆï¼‰</label><input id="taskName" required></div>
    <div class="field"><label>æ‰€è¦åˆ†ï¼ˆ0.5ã€œ30ã®ç¯„å›²ï¼‰</label><input id="taskMinutes" type="number" min="0.5" max="30" step="0.5" value="1"></div>
    <div class="field">
      <label>ãƒã‚§ãƒƒã‚¯æ–¹å¼</label>
      <select id="taskMode">
        <option value="tap">ã‚¿ãƒƒãƒ—</option>
        <option value="timer">ã‚¿ã‚¤ãƒãƒ¼</option>
      </select>
    </div>
    <div class="field">
      <label>ã‚¢ã‚¤ã‚³ãƒ³</label>
      <div class="chips" id="iconPicker">
        <span class="chip active" data-icon="sun">ğŸŒ</span>
        <span class="chip" data-icon="toilet">ğŸš»</span>
        <span class="chip" data-icon="wash">ğŸ§¼</span>
        <span class="chip" data-icon="tooth">ğŸª¥</span>
        <span class="chip" data-icon="dress">ğŸ‘—</span>
        <span class="chip" data-icon="bag">ğŸ’</span>
        <span class="chip" data-icon="rice">ğŸš</span>
        <span class="chip" data-icon="clean">ğŸ§¹</span>
        <span class="chip" data-icon="run">ğŸƒ</span>
        <span class="chip" data-icon="star">â­</span>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
      <button id="btnDeleteTask" class="btn danger" type="button">å‰Šé™¤</button>
      <button id="btnSaveTask" class="btn ok" type="button">ä¿å­˜</button>
    </div>
  </form>
</dialog>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ™‚åˆ»ç·¨é›† -->
<dialog id="dlgTime">
  <form method="dialog">
    <h3>å‡ºç™ºæ™‚åˆ»ã®ç·¨é›†</h3>
    <div class="chips" id="quickTimes">
      <span class="chip" data-time="07:30">07:30</span>
      <span class="chip" data-time="07:55">07:55</span>
      <span class="chip" data-time="08:30">08:30</span>
      <span class="chip" data-time="09:00">09:00</span>
    </div>
    <div class="field"><label>ã‚«ã‚¹ã‚¿ãƒ </label><input id="customTime" placeholder="HH:MM ä¾‹ 08:10"></div>
    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
      <button class="btn">ã¨ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<!-- SVG Spritesï¼ˆUIãƒ”ã‚¯ãƒˆï¼‰ -->
<svg xmlns="http://www.w3.org/2000/svg" class="sr-only">
  <symbol id="i-sun" viewBox="0 0 24 24"><path d="M12 4V2m0 20v-2m8-8h2M2 12h2m13.657-6.343 1.414-1.414M6.929 19.071l-1.414 1.414M17.071 19.071l1.414 1.414M4.515 4.515l1.414 1.414"/><circle cx="12" cy="12" r="5"/></symbol>
</svg>

<script type="module">
// @ts-check

/**********************
 * å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 **********************/
const STORAGE_KEY = 'morningCoach.v1';
const CACHE_BUST = 'v1';
const MAX_TASKS = 50;
const MIN_MINUTES = 0.5;
const MAX_MINUTES = 30;

const qs = (sel, root=document) => /** @type {HTMLElement} */(root.querySelector(sel));
const qsa = (sel, root=document) => /** @type {NodeListOf<HTMLElement>} */(root.querySelectorAll(sel));

/** æ–‡å­—åˆ—"HH:MM"â†’åˆ† */
function hhmmToMin(hhmm){const [h,m]=hhmm.split(':').map(Number);return h*60+m}
/** åˆ†â†’"HH:MM"ï¼ˆ0è©°ã‚ï¼‰ */
function minToHHMM(min){min=((min%1440)+1440)%1440;const h=Math.floor(min/60),m=min%60;return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`}
/** ç¾åœ°ï¼ˆAsia/Tokyoï¼‰ã®æ›œæ—¥ã‚­ãƒ¼ */
function weekdayKey(){
  const now=new Date();
  const tz='Asia/Tokyo';
  const s = new Intl.DateTimeFormat('en-GB',{timeZone:tz,weekday:'short'}).format(now); // Mon/Tue...
  return {Mon:'Mon',Tue:'Tue',Wed:'Wed',Thu:'Thu',Fri:'Fri',Sat:'Sat',Sun:'Sun'}[s]||'Mon';
}
/** ä»Šæ—¥ã®YYYY-MM-DDï¼ˆæ±äº¬ï¼‰ */
function todayStr(){
  const tz='Asia/Tokyo'; const now=new Date();
  const y=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric'}).format(now);
  const m=new Intl.DateTimeFormat('en-CA',{timeZone:tz,month:'2-digit'}).format(now);
  const d=new Intl.DateTimeFormat('en-CA',{timeZone:tz,day:'2-digit'}).format(now);
  return `${y}-${m}-${d}`;
}

/**********************
 * ãƒ‡ãƒ¼ã‚¿å±¤
 **********************/
/** @typedef {{id:string,label:string,minutes:number,icon:string,mode:'tap'|'timer'}} Task */
/** @typedef {{name:string,age:number,targetDeparture:string,byWeekday:Record<string,string>,todayOverride:string|null,tasks:Task[], simpleMode:boolean, stars:number}} Profile */
/** @typedef {{profiles:Record<string,Profile>, settings:{ttsRate:number,ttsPitch:number,ttsVolume:number,dualMode:'auto'|'tabs'|'split', parentPin?:string}, stats:{stampsByDate:Record<string,Record<string,boolean>>}} State */

const defaultState = /** @type {State} */({
  profiles:{
    kid_6:{ name:'6æ­³', age:6, targetDeparture:'07:55',
      byWeekday:{Mon:'07:55',Tue:'07:55',Wed:'07:55',Thu:'07:55',Fri:'07:55',Sat:'09:00',Sun:'09:00'},
      todayOverride:null,
      tasks:[
        {id:'wake',label:'èµ·åºŠ',minutes:1,icon:'sun',mode:'tap'},
        {id:'toilet',label:'ãƒˆã‚¤ãƒ¬',minutes:3,icon:'toilet',mode:'timer'},
        {id:'wash',label:'é¡”ã‚’æ´—ã†',minutes:2,icon:'wash',mode:'tap'},
        {id:'tooth',label:'æ­¯ã¿ãŒã',minutes:2,icon:'tooth',mode:'timer'},
        {id:'dress',label:'ç€æ›¿ãˆ',minutes:3,icon:'dress',mode:'tap'},
        {id:'bag',label:'æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯',minutes:2,icon:'bag',mode:'tap'},
        {id:'rice',label:'æœã”ã¯ã‚“',minutes:10,icon:'rice',mode:'timer'},
        {id:'clean',label:'ç‰‡ä»˜ã‘',minutes:2,icon:'clean',mode:'tap'},
        {id:'run',label:'å‡ºç™ºæº–å‚™',minutes:1,icon:'run',mode:'tap'},
      ],
      simpleMode:false, stars:0
    },
    kid_3:{ name:'3æ­³', age:3, targetDeparture:'09:00',
      byWeekday:{Mon:'09:00',Tue:'09:00',Wed:'09:00',Thu:'09:00',Fri:'09:00',Sat:'09:30',Sun:'09:30'},
      todayOverride:null,
      tasks:[
        {id:'wake',label:'èµ·åºŠ',minutes:1,icon:'sun',mode:'tap'},
        {id:'toilet_assist',label:'ãƒˆã‚¤ãƒ¬ï¼ˆè£œåŠ©ï¼‰',minutes:4,icon:'toilet',mode:'timer'},
        {id:'wipe_face',label:'é¡”ã‚’æ‹­ã',minutes:2,icon:'wash',mode:'tap'},
        {id:'tooth',label:'æ­¯ã¿ãŒãï¼ˆè£œåŠ©ï¼‰',minutes:2,icon:'tooth',mode:'timer'},
        {id:'dress',label:'ç€æ›¿ãˆ',minutes:3,icon:'dress',mode:'tap'},
        {id:'socks',label:'é´ä¸‹',minutes:1,icon:'dress',mode:'tap'},
        {id:'rice',label:'æœã”ã¯ã‚“',minutes:12,icon:'rice',mode:'timer'},
        {id:'clean',label:'ç‰‡ä»˜ã‘',minutes:2,icon:'clean',mode:'tap'},
        {id:'run',label:'å‡ºç™ºæº–å‚™',minutes:1,icon:'run',mode:'tap'},
        {id:'custom_x',label:'ï¼ˆè¦ªãŒè¿½åŠ ï¼‰',minutes:5,icon:'star',mode:'tap'},
      ],
      simpleMode:false, stars:0
    }
  },
  settings:{ ttsRate:1.0, ttsPitch:1.0, ttsVolume:1.0, dualMode:'auto', parentPin:'' },
  stats:{ stampsByDate:{} }
});

let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return structuredClone(defaultState); }
    const s = JSON.parse(raw);
    return {...structuredClone(defaultState), ...s};
  }catch(e){
    console.warn('state parse failed, reset', e);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState));
    return structuredClone(defaultState);
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/**********************
 * éŸ³å£°ï¼ˆTTS/ASRï¼‰
 **********************/
let voiceJA = null;
/** @param {string} text */
function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  if(voiceJA) u.voice = voiceJA;
  u.lang = 'ja-JP';
  u.rate = state.settings.ttsRate;
  u.pitch = state.settings.ttsPitch;
  u.volume = state.settings.ttsVolume;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
function pickJapaneseVoice(){
  const voices = speechSynthesis.getVoices();
  voiceJA = voices.find(v=>/ja-JP/i.test(v.lang)) || voices.find(v=>/ja/i.test(v.lang)) || null;
}
speechSynthesis.addEventListener('voiceschanged', pickJapaneseVoice);
pickJapaneseVoice();

// ASRï¼ˆwebkitSpeechRecognitionï¼‰å­˜åœ¨ãƒã‚§ãƒƒã‚¯
const hasASR = typeof window !== 'undefined' && 'webkitSpeechRecognition' in window;
function startMoodASR(onResult){
  if(!hasASR){ onResult(null); return; }
  const rec = new window.webkitSpeechRecognition();
  rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onresult = (ev)=>{
    const t = ev.results[0][0].transcript.trim();
    onResult(t);
  };
  rec.onerror = ()=>onResult(null);
  rec.start();
}

/**********************
 * UIæç”»ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ
 **********************/
const tabs = qs('#tabs');
const grid = qs('#home');
function applyDualMode(){
  const isSplit = (state.settings.dualMode==='split') || (state.settings.dualMode==='auto' && window.innerWidth>=1024);
  grid.classList.toggle('split', isSplit);
  tabs.style.display = isSplit ? 'none' : 'flex';
  qs('#modePill').textContent = isSplit ? 'iPad:åˆ†å‰²è¡¨ç¤º' : 'iPhone:ã‚¿ãƒ–åˆ‡æ›¿';
}
applyDualMode();
window.addEventListener('resize', applyDualMode);

qsa('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    qsa('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.target;
    qsa('article[id^="panel_"]').forEach(p=>p.style.display='none');
    qs(`#panel_${target}`).style.display='block';
  });
});
// åˆæœŸï¼šiPhoneæƒ³å®šã§kid_6ã®ã¿è¡¨ç¤ºï¼ˆiPadã¯CSSã§ä¸¡æ–¹è¡¨ç¤ºï¼‰
qs('#panel_kid_3').style.display='none';

function profileOf(id){ return state.profiles[id]; }
function effectiveDeparture(p){
  return p.todayOverride || p.byWeekday[weekdayKey()] || p.targetDeparture;
}
function remainingMinutes(p){
  const nowMin = hhmmToMin(new Intl.DateTimeFormat('en-GB',{timeZone:'Asia/Tokyo',hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date()));
  const dep = hhmmToMin(effectiveDeparture(p));
  return dep - nowMin;
}
function renderProfile(id){
  const p = profileOf(id);
  // æ®‹ã‚Šæ™‚é–“
  const rem = remainingMinutes(p);
  const remainEl = qs(`#remain_${id}`);
  const departEl = qs(`#depart_${id}`);
  remainEl.textContent = rem>=0 ? `${String(Math.floor(rem/60)).padStart(2,'0')}:${String(Math.abs(rem%60)).padStart(2,'0')}` : `é…ã‚Œ ${Math.abs(rem)}åˆ†`;
  departEl.querySelector('strong').textContent = effectiveDeparture(p);

  // ç¾åœ¨ã‚¿ã‚¹ã‚¯ï¼ˆå…ˆé ­æœªå®Œï¼‰
  const nowTask = p.tasks[0];
  qs(`#now_${id}`).textContent = nowTask ? nowTask.label : 'ã™ã¹ã¦å®Œäº†ï¼';
  qs(`#meta_${id}`).textContent = nowTask ? `æ‰€è¦ ${nowTask.minutes}åˆ† / ãƒ¢ãƒ¼ãƒ‰:${nowTask.mode==='timer'?'ã‚¿ã‚¤ãƒãƒ¼':'ã‚¿ãƒƒãƒ—'}` : '';
  // æ¬¡ã‚¿ã‚¹ã‚¯
  qs(`#next_${id}`).textContent = p.tasks[1] ? `ã¤ãï¼šã€Œ${p.tasks[1].label}ã€ / ${p.tasks[1].minutes}åˆ†` : 'ã¤ãï¼šâ€”';
  // ã‚¹ã‚¿ãƒ¼
  qs(`#stars_${id}`).textContent = `â­${p.stars|0}`;

  // ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆ
  const list = qs(`#list_${id}`);
  list.innerHTML = '';
  p.tasks.forEach((t, idx)=>{
    const item = document.createElement('div');
    item.className='taskitem';
    item.draggable=true;
    item.dataset.index=String(idx);
    item.innerHTML = `
      <div class="drag" aria-grabbed="false" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ">â†•</div>
      <div style="font-size:20px">${iconEmoji(t.icon)}</div>
      <div style="flex:1">
        <div><strong>${t.label}</strong></div>
        <div class="taskmeta">${t.minutes}åˆ† / ${t.mode==='timer'?'ã‚¿ã‚¤ãƒãƒ¼':'ã‚¿ãƒƒãƒ—'}</div>
      </div>
      <button class="btn ghost" data-edit-one="${idx}">ç·¨é›†</button>
    `;
    list.appendChild(item);
  });
  setupDnD(list, id);
}

function iconEmoji(name){
  return {sun:'ğŸŒ',toilet:'ğŸš»',wash:'ğŸ§¼',tooth:'ğŸª¥',dress:'ğŸ‘—',bag:'ğŸ’',rice:'ğŸš',clean:'ğŸ§¹',run:'ğŸƒ',star:'â­'}[name] || 'â­';
}

function setupDnD(listEl, profileId){
  let dragIdx=null;
  listEl.addEventListener('dragstart', (e)=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; dragIdx=Number(t.dataset.index); t.style.opacity='.6'; });
  listEl.addEventListener('dragend', (e)=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; t.style.opacity='1'; });
  listEl.addEventListener('dragover', (e)=>{ e.preventDefault(); const after = (e.target.closest('.taskitem')); if(!after) return; });
  listEl.addEventListener('drop', (e)=>{
    e.preventDefault();
    const after = /** @type {HTMLElement|null} */(e.target.closest('.taskitem'));
    if(after==null || dragIdx==null) return;
    const dropIdx = Number(after.dataset.index);
    if(dropIdx===dragIdx) return;
    const arr = profileOf(profileId).tasks;
    const [m]=arr.splice(dragIdx,1); arr.splice(dropIdx,0,m);
    saveState(); renderProfile(profileId);
  });

  // å€‹åˆ¥ç·¨é›†ãƒœã‚¿ãƒ³
  listEl.addEventListener('click',(e)=>{
    const btn = e.target;
    if(!(btn instanceof HTMLElement)) return;
    const idx = btn.dataset.editOne;
    if(idx!=null){ openTaskEditor(profileId, Number(idx)); }
  });
}

// ã‚¤ãƒ™ãƒ³ãƒˆï¼šé•·æŠ¼ã—ã§æ™‚åˆ»ç·¨é›†
['kid_6','kid_3'].forEach(id=>{
  const el = qs(`#depart_${id}`);
  let timer=null;
  el.addEventListener('touchstart', ()=>{ timer=setTimeout(()=>openTimeEditor(id), 500); }, {passive:true});
  el.addEventListener('touchend', ()=>{ clearTimeout(timer); });
  el.addEventListener('mousedown', ()=>{ timer=setTimeout(()=>openTimeEditor(id), 500); });
  el.addEventListener('mouseup', ()=>{ clearTimeout(timer); });
});

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç¾¤
qsa('.controls').forEach(box=>{
  box.addEventListener('click',(e)=>{
    const btn = e.target;
    if(!(btn instanceof HTMLElement)) return;
    const cmd = btn.dataset.cmd; const id = btn.dataset.profile;
    if(!cmd || !id) return;
    const p = profileOf(id);
    if(cmd==='begin'){
      playJingle(); // åˆå›ã‚¿ãƒƒãƒ—å¾Œã®éŸ³å‡ºã—ï¼ˆiOSè§£ç¦ï¼‰
      speak(`ãŠã¯ã‚ˆã†ï¼${p.name}ã¡ã‚ƒã‚“ã€ãã‚‡ã†ã®æ°—åˆ†ã¯ï¼Ÿ ãƒ¯ã‚¯ãƒ¯ã‚¯ãƒ»ã­ã‚€ã„ãƒ»ãµã¤ã† ã‹ã‚‰ãˆã‚‰ã‚“ã§ã­ã€‚`);
      // ASR or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      startMoodASR((txt)=>{
        if(!txt){
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é¸æŠè‚¢ã‚’éŸ³å£°ã§ä¿ƒã™
          speak('ç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ°—åˆ†ã‚’ãˆã‚‰ã‚“ã§ã­ã€‚');
          showMoodChoices(id);
        }else{
          handleMood(id, txt);
        }
      });
    }
    if(cmd==='done'){ completeCurrent(id); }
    if(cmd==='hint'){ showHint(id); }
    if(cmd==='skip'){ guardParent(()=>skipCurrent(id)); }
    if(cmd==='simple'){ toggleSimple(id); }
  });
});

function showMoodChoices(id){
  const p=profileOf(id);
  const msg = `ãã¶ã‚“ã¯ã©ã†ï¼Ÿ`; window.alert(msg + '\n\nï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯UIï¼šã“ã®ã‚ã¨æœ€åˆã®ã‚¿ã‚¹ã‚¯ã¸é€²ã¿ã¾ã™ï¼‰');
}
function handleMood(id, text){
  const t = text.replace(/\s/g,'');
  if(t.includes('ãƒ¯ã‚¯ãƒ¯ã‚¯')) speak('ãƒ¯ã‚¯ãƒ¯ã‚¯ã€ã„ã„ã­ï¼ ã˜ã‚ƒã‚ã€ãƒˆã‚¤ãƒ¬ã‹ã‚‰ã„ã£ã¦ã¿ã‚ˆã†ï¼');
  else if(t.includes('ã­ã‚€ã„')) speak('ã­ã‚€ã„ã‚ˆã­ã€‚ã¾ãšã¯ãŠæ°´ã‚’ä¸€å£ã®ã‚“ã§ã€ãƒˆã‚¤ãƒ¬ã«ã„ã“ã†ï¼');
  else speak('ãã®æ°—æŒã¡ã€ã ã„ã˜ã€‚ã„ã£ã—ã‚‡ã«å°‘ã—ãšã¤é€²ã‚‚ã†ï¼ ã¾ãšã¯ãƒˆã‚¤ãƒ¬ã‹ã‚‰ï¼');
}

function completeCurrent(id){
  const p = profileOf(id);
  if(p.tasks.length===0) return;
  const t = p.tasks.shift();
  p.stars = (p.stars|0)+1;
  // ãƒãƒƒã‚¸/ã‚¹ã‚¿ãƒ³ãƒ—
  const d = todayStr();
  state.stats.stampsByDate[d] = state.stats.stampsByDate[d]||{};
  state.stats.stampsByDate[d][id] = true;

  speak(`ã€Œ${t.label}ã€ã§ããŸï¼ ã™ã°ã‚‰ã—ã„ï¼ ã¤ãã¯ã€Œ${p.tasks[0]?.label||'ãŠã—ã¾ã„'}ã€ã ã‚ˆã€‚`);
  saveState(); renderProfile(id);
  if(p.tasks.length===0) speak('ãã‚‡ã†ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€ãœã‚“ã¶ã‚¯ãƒªã‚¢ï¼ ã”ã»ã†ã³ã‚«ãƒ¼ãƒ‰ã‚’ã‚²ãƒƒãƒˆï¼');
}

function showHint(id){
  const t = profileOf(id).tasks[0];
  const hints = {
    'ãƒˆã‚¤ãƒ¬':'ãŠã¸ã‚„â†’ãƒˆã‚¤ãƒ¬â†’ã¦ã‚’ã‚ã‚‰ã†ã€ã®ã˜ã‚…ã‚“ã°ã‚“ã ã‚ˆã€‚',
    'é¡”ã‚’æ´—ã†':'ã¬ã‚‹ã¾ã‚†ã§ãã£ã¨ã­ã€‚ã‚¿ã‚ªãƒ«ã§ã‚„ã•ã—ããµã“ã†ï¼',
    'é¡”ã‚’æ‹­ã':'ã¬ã‚Œã‚¿ã‚ªãƒ«ã§ãŠã§ã“ãƒ»ã»ã£ãºãƒ»ã‚ã”ã®é †ã«ã€‚',
    'æ­¯ã¿ãŒã':'ã†ãˆãƒ»ã—ãŸãƒ»ã†ã‚‰ã€‚30ã³ã‚‡ã†ã‚¿ã‚¤ãƒãƒ¼ï¼',
    'ç€æ›¿ãˆ':'ãƒˆãƒƒãƒ—ã‚¹â†’ãƒœãƒˆãƒ ã‚¹â†’ãã¤ã—ãŸã®é †ã§OKï¼',
    'é´ä¸‹':'ã‹ã‹ã¨ãƒãƒ¼ã‚¯ã‚’ã‚ã‚ã›ã‚ˆã†ï¼',
    'æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯':'ã‚Œã‚“ã‚‰ãã¡ã‚‡ã†ãƒ»ãƒãƒ³ã‚«ãƒãƒ»ãƒ†ã‚£ãƒƒã‚·ãƒ¥ï¼',
    'æœã”ã¯ã‚“':'ã‚ˆãã‹ã‚“ã§é£Ÿã¹ã‚ˆã†ã€‚',
    'ç‰‡ä»˜ã‘':'ãŠã•ã‚‰ã‚’ã‚·ãƒ³ã‚¯ã¸ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãµããµãã€‚',
    'å‡ºç™ºæº–å‚™':'ã¼ã†ã—ãƒ»ãƒã‚¹ã‚¯ãƒ»ãã¤ã€ã‚ˆã—ï¼'
  };
  speak(hints[t?.label] || 'ã‚†ã£ãã‚Šã§ã ã„ã˜ã‚‡ã†ã¶ã€ã„ã£ã—ã‚‡ã«ã‚„ã‚ã†ï¼');
}

function skipCurrent(id){
  const p = profileOf(id);
  if(p.tasks.length===0) return;
  const t = p.tasks.shift();
  speak(`ã€Œ${t.label}ã€ã¯ãã‚‡ã†ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚ ã¤ãã¯ã€Œ${p.tasks[0]?.label||'ãŠã—ã¾ã„'}ã€ï¼`);
  saveState(); renderProfile(id);
}

function toggleSimple(id){
  const p = profileOf(id);
  p.simpleMode = !p.simpleMode;
  if(p.simpleMode){
    // é‡è¦ã‚¿ã‚¹ã‚¯ã ã‘æ®‹ã™ç°¡æ˜“åŒ–ï¼ˆä¾‹ï¼‰
    p.tasks = p.tasks.filter(x=>['èµ·åºŠ','ãƒˆã‚¤ãƒ¬','é¡”ã‚’æ´—ã†','é¡”ã‚’æ‹­ã','æ­¯ã¿ãŒã','å‡ºç™ºæº–å‚™','ç€æ›¿ãˆ','é´ä¸‹'].includes(x.label));
    speak('ã‚«ãƒ³ã‚¿ãƒ³ç‰ˆã«åˆ‡ã‚Šæ›¿ãˆãŸã‚ˆã€‚ãŸã„ã›ã¤ãªã‚¿ã‚¹ã‚¯ã ã‘ã«ã—ãŸã‚ˆã€‚');
  }else{
    speak('ãµã¤ã†ç‰ˆã«ã‚‚ã©ã—ãŸã‚ˆã€‚');
  }
  saveState(); renderProfile(id);
}

// è¦ªã‚¬ãƒ¼ãƒ‰
function guardParent(fn){
  const pin=state.settings.parentPin||'';
  if(!pin){ fn(); return; }
  const input = prompt('è¦ªPINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ4æ¡ï¼‰');
  if(input===pin) fn(); else alert('PINãŒã¡ãŒã„ã¾ã™');
}

/**********************
 * ã‚¿ã‚¹ã‚¯ç·¨é›†/è¿½åŠ 
 **********************/
const dlgTask = /** @type {HTMLDialogElement} */(qs('#dlgTask'));
let currentTaskCtx = {profileId:'kid_6', index:-1};
function openTaskEditor(profileId, index=-1){
  currentTaskCtx={profileId, index};
  const isNew = index===-1;
  qs('#taskName').value = isNew ? '' : profileOf(profileId).tasks[index].label;
  qs('#taskMinutes').value = isNew ? '1' : String(profileOf(profileId).tasks[index].minutes);
  qs('#taskMode').value = isNew ? 'tap' : profileOf(profileId).tasks[index].mode;
  qsa('#iconPicker .chip').forEach(c=>c.classList.remove('active'));
  const icon = isNew ? 'sun' : profileOf(profileId).tasks[index].icon;
  const chip = qs(`#iconPicker .chip[data-icon="${icon}"]`); chip.classList.add('active');
  dlgTask.showModal();
}
qsa('.editlink').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const el = /** @type {HTMLElement} */(e.currentTarget);
    const profileId = el.dataset.profile;
    if(el.dataset.edit==='tasks'){ guardParent(()=>openTaskEditor(profileId,-1)); }
    if(el.dataset.edit==='export'){ exportProfile(profileId); }
    if(el.dataset.edit==='import'){ importProfile(profileId); }
  });
});
qs('#btnSaveTask').addEventListener('click', ()=>{
  const name = qs('#taskName').value.trim();
  const minutes = Number(qs('#taskMinutes').value);
  const mode = /** @type {'tap'|'timer'} */(qs('#taskMode').value);
  const icon = /** @type {HTMLElement} */(qs('#iconPicker .chip.active')).dataset.icon;
  if(!name){ alert('åå‰ã¯å¿…é ˆã§ã™'); return; }
  if(!(minutes>=MIN_MINUTES && minutes<=MAX_MINUTES)){ alert('æ‰€è¦ã¯0.5ã€œ30åˆ†'); return; }
  const arr = profileOf(currentTaskCtx.profileId).tasks;
  if(currentTaskCtx.index===-1){
    if(arr.length>=MAX_TASKS){alert('ã‚¿ã‚¹ã‚¯ã¯æœ€å¤§50ä»¶ã§ã™'); return;}
    arr.push({id:`t_${Date.now()}`,label:name,minutes,icon,mode});
  }else{
    Object.assign(arr[currentTaskCtx.index], {label:name,minutes,icon,mode});
  }
  saveState(); renderProfile(currentTaskCtx.profileId); dlgTask.close();
});
qs('#btnDeleteTask').addEventListener('click', ()=>{
  if(currentTaskCtx.index===-1){ dlgTask.close(); return; }
  const arr = profileOf(currentTaskCtx.profileId).tasks;
  arr.splice(currentTaskCtx.index,1);
  saveState(); renderProfile(currentTaskCtx.profileId); dlgTask.close();
});
qsa('#iconPicker .chip').forEach(c=>c.addEventListener('click',()=>{
  qsa('#iconPicker .chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
}));

/**********************
 * æ™‚åˆ»ç·¨é›†ï¼ˆé•·æŠ¼ã—ï¼‰
 **********************/
const dlgTime = /** @type {HTMLDialogElement} */(qs('#dlgTime'));
let timeEditTarget = 'kid_6';
function openTimeEditor(profileId){
  timeEditTarget = profileId;
  dlgTime.showModal();
}
qsa('#quickTimes .chip').forEach(c=>c.addEventListener('click',()=>{
  const t = c.dataset.time; applyTimeEdit(t);
}));
qs('#customTime').addEventListener('change', (e)=>{
  const t = /** @type {HTMLInputElement} */(e.target).value.trim();
  if(!/^\d{2}:\d{2}$/.test(t)) { alert('HH:MMå½¢å¼ã§å…¥åŠ›ãã ã•ã„'); return; }
  applyTimeEdit(t);
});
function applyTimeEdit(t){
  const p = profileOf(timeEditTarget);
  p.todayOverride = t;
  speak(`ãã‚‡ã†ã ã‘å‡ºç™ºæ™‚åˆ»ã‚’ ${t} ã«ã—ãŸã‚ˆã€‚`);
  saveState(); renderProfile(timeEditTarget); dlgTime.close();
}

/**********************
 * è¦ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
 **********************/
const dlgParent = /** @type {HTMLDialogElement} */(qs('#dlgParent'));
qs('#btnParent').addEventListener('click', ()=>{ guardParent(()=>dlgParent.showModal()); });
qs('#parentProfileSel').addEventListener('change', e=>{
  const id = /** @type {HTMLSelectElement} */(e.target).value;
  // è¡¨ç¤ºæ›´æ–°
  renderProfile(id);
});
qsa('[data-qtime]').forEach(ch=>ch.addEventListener('click',()=>{
  const t = ch.dataset.qtime;
  const id = /** @type {HTMLSelectElement} */(qs('#parentProfileSel')).value;
  const p = profileOf(id);
  p.todayOverride = t;
  saveState(); renderProfile(id);
}));
qs('#byWeekdayInput').addEventListener('change',(e)=>{
  const id = /** @type {HTMLSelectElement} */(qs('#parentProfileSel')).value;
  try{
    const obj = JSON.parse(/** @type {HTMLInputElement} */(e.target).value);
    state.profiles[id].byWeekday = obj; saveState(); renderProfile(id);
  }catch{ alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™'); }
});
qs('#todayOverrideInput').addEventListener('change',(e)=>{
  const id = /** @type {HTMLSelectElement} */(qs('#parentProfileSel')).value;
  const v = /** @type {HTMLInputElement} */(e.target).value.trim();
  state.profiles[id].todayOverride = v || null; saveState(); renderProfile(id);
});
qs('#parentPinInput').addEventListener('change',(e)=>{
  state.settings.parentPin = /** @type {HTMLInputElement} */(e.target).value.trim();
  saveState();
});
qs('#btnExportAll').addEventListener('click', exportAll);
qs('#importFile').addEventListener('change', async (e)=>{
  const file = /** @type {HTMLInputElement} */(e.target).files?.[0]; if(!file) return;
  const text = await file.text();
  try{
    const obj = JSON.parse(text);
    state = obj; saveState(); location.reload();
  }catch{ alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™'); }
});
qs('#btnCacheUpdate').addEventListener('click', async ()=>{
  await navigator.serviceWorker?.getRegistration()?.then(r=>r?.update());
  alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
});

/**********************
 * ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å˜ä½ï¼‰
 **********************/
function exportProfile(id){
  const data = { [id]: state.profiles[id] };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `morningCoach_${id}_${todayStr()}.json`;
  a.click();
}
function importProfile(id){
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = async ()=>{
    const file = input.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const obj = JSON.parse(text);
      if(obj[id]){ state.profiles[id]=obj[id]; saveState(); renderProfile(id); }
      else alert('æŒ‡å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }catch{ alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™'); }
  };
  input.click();
}
function exportAll(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `morningCoach_all_${todayStr()}.json`;
  a.click();
}

/**********************
 * è»½é‡ãƒªãƒ—ãƒ©ãƒ³ææ¡ˆ
 **********************/
function maybeSuggest(id){
  const p = profileOf(id);
  const rem = remainingMinutes(p);
  const need = p.tasks.reduce((s,t)=>s+t.minutes,0);
  if(need>rem && p.tasks.length>=2){
    const pair = `${p.tasks[0].label} ã¨ ${p.tasks[1].label}`;
    qs(`#next_${id}`).textContent = `æ™‚é–“ãŒå°‘ãªã„ã‚ˆã€‚${pair} ã‚’åŒæ™‚ã«ã‚„ã£ã¦ã¿ã‚‹ï¼Ÿ`;
  }
}

/**********************
 * ã‚¸ãƒ³ã‚°ãƒ«ï¼ˆWebAudioç”Ÿæˆï¼‰
 **********************/
let audioCtx=null;
function playJingle(){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const ctx=audioCtx; const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='triangle'; o.frequency.value=660; g.gain.value=.0001;
    o.connect(g).connect(ctx.destination); o.start();
    const now=ctx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.2, now+.02);
    o.frequency.exponentialRampToValueAtTime(990, now+.25);
    g.gain.exponentialRampToValueAtTime(0.0001, now+.35);
    o.stop(now+.4);
  }catch{}
}

/**********************
 * Service Workerç™»éŒ²
 **********************/
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js?'+CACHE_BUST).catch(()=>{});
  });
}

/**********************
 * æ¯ç§’æ›´æ–°
 **********************/
function tick(){
  ['kid_6','kid_3'].forEach(id=>{
    renderProfile(id);
    maybeSuggest(id);
  });
}
setInterval(tick, 1000);
tick(); // åˆæœŸè¡¨ç¤º
</script>
</body>
</html>
